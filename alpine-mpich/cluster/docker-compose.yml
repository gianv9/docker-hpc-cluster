version: '3.3'

# volumes:
#   vol_debug:
#     driver: local
#     driver_opts:
#       type: "nfs"
#       o: addr=192.168.1.115,nolock,soft,rw
#       device: ":/opt/nfs/volumes/debug"

services:
  # registry:
  #   image: registry
  #   ports:
  #     - "${REGISTRY_PORT}:5000"

  master:
    # image: ${REGISTRY_ADDR}:5000/${IMAGE_NAME}
    image: ${IMAGE_NAME}
    user: root
    entrypoint: ["mpi_bootstrap", "role=master", "mpi_master_service_name=master", "mpi_worker_service_name=worker"]
    ports:
      - "2222:22"
    # volumes:
    #   - type: volume
    #     source: vol_debug
    #     target: /data
    #     volume:
    #       nocopy: true
    # networks:
    #   - cluster_net

  worker:
    # image: ${REGISTRY_ADDR}:5000/${IMAGE_NAME}
    image: ${IMAGE_NAME}
    deploy:
      replicas: ${REPLICAS}
    user: root
    entrypoint: ["mpi_bootstrap", "role=worker", "mpi_master_service_name=master", "mpi_worker_service_name=worker"]
  #   networks:
  # #     - cluster_net

networks:
  default:
    external:
      name: cluster_net

# volumes:
#   nfs_share:

# networks:
#   # net:
#   default:
#     driver: overlay
#     # enable_ipv6: true
#     ipam:
#       driver: default
#       config:
#       -
#         subnet: 10.0.9.0/24